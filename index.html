<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üñêÔ∏è Ride with Secret Code</title>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.js" crossorigin="anonymous"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        text-align: center;
        background: #f0f0f0;
    }

    h1 {
        font-size: 24px;
        margin: 20px 0 10px;
    }

    button {
        padding: 12px 24px;
        font-size: 18px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 20px;
    }

    button:hover {
        background: #0056b3;
    }

    canvas {
        border: 5px solid #333;
        border-radius: 12px;
        width: 100%;
        height: auto;
        max-width: 640px;
        margin-bottom: 20px;
    }

    @media (max-width: 768px) {
        h1 {
            font-size: 20px;
            margin: 15px 0 10px;
        }
        button {
            font-size: 16px;
            padding: 10px 20px;
        }
    }
</style>
</head>

<body>
<h1>Show an üñêÔ∏è ‚Üí Secret Code Appears!</h1>
<button id="startBtn">Activate Camera</button>

<h2>How to Use</h2>
<ol style="text-align:left; max-width: 600px; margin: 0 auto 20px;">
    <li>Click <strong>Activate Camera</strong> to start your camera.</li>
    <li>Show an <strong>open hand</strong> to the camera to reveal the secret code.</li>
    <li>Hold your hand steady for <strong>3 seconds</strong> to master your ride</li>
    <li>Once the picture is snapped, tap on the code to book now.</li>
</ol>
<div>
    <canvas id="output_canvas" width="640" height="480"></canvas>
</div>

<script>
const startBtn = document.getElementById('startBtn');
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d');

let videoElement;
let paperDetected = false;
let holdStartTime = null;
let frozen = false;
let badgePos = { x: 0, y: 0 };

startBtn.onclick = async () => {
    startBtn.style.display = 'none';

    videoElement = document.createElement('video');
    videoElement.autoplay = true;
    videoElement.playsInline = true;
    videoElement.style.display = 'none';
    document.body.appendChild(videoElement);

    const hands = new Hands({
        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/${file}`
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.6,
        minTrackingConfidence: 0.6
    });

    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => await hands.send({ image: videoElement }),
        width: 640,
        height: 480,
        facingMode: 'user'
    });

    camera.start();

    // Responsive canvas
    videoElement.addEventListener('loadedmetadata', () => {
        const aspect = videoElement.videoHeight / videoElement.videoWidth;

        function resizeCanvas() {
            const displayWidth = Math.min(window.innerWidth - 20, 640);
            canvas.width = displayWidth;
            canvas.height = displayWidth * aspect;
        }

        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    });
};

function drawBadge(x, y, clickable) {
    const badgeWidth = 200;
    const badgeHeight = 50;

    ctx.fillStyle = '#000';
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.shadowColor = clickable ? '#00FFCC' : '#888';
    ctx.shadowBlur = clickable ? 15 : 5;
    ctx.fillRect(x - badgeWidth / 2, y - badgeHeight / 2, badgeWidth, badgeHeight);
    ctx.strokeRect(x - badgeWidth / 2, y - badgeHeight / 2, badgeWidth, badgeHeight);

    ctx.font = "bold 20px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = "#fff";
    ctx.shadowBlur = 0;
    ctx.fillText("SECRET-CODE", x, y + 7);

    // Save badge position for click detection
    badgePos = { x: x - badgeWidth/2, y: y - badgeHeight/2, width: badgeWidth, height: badgeHeight };
}

function onResults(results) {
    if (frozen) return; // stop updating canvas after freeze

    ctx.save();
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (results.image) {
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
    }

    let currentPaper = false;

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];

        if (isPaper(landmarks)) {
            currentPaper = true;

            if (!holdStartTime) holdStartTime = performance.now();
            const elapsed = (performance.now() - holdStartTime) / 1000;

            const palm = landmarks[9];
            const x = palm.x * canvas.width;
            const y = palm.y * canvas.height;

            drawBadge(x, y, elapsed >= 3);

            if (elapsed >= 3) {
                frozen = true; // freeze canvas
            }
        }
    }

    if (!currentPaper) {
        holdStartTime = null;
    }

    paperDetected = currentPaper;
    ctx.restore();
}

function isPaper(landmarks) {
    const tips = [4, 8, 12, 16, 20];
    const mcps = [2, 5, 9, 13, 17];
    let extended = 0;

    for (let i = 0; i < 5; i++) {
        if (landmarks[tips[i]].y < landmarks[mcps[i]].y - 0.03) extended++;
    }
    if (extended < 4) return false;

    const xs = tips.map(i => landmarks[i].x).sort((a, b) => a - b);
    for (let i = 1; i < xs.length; i++) {
        if (xs[i] - xs[i - 1] < 0.03) return false;
    }
    return true;
}

// Canvas click opens Uber deeplink if frozen
canvas.addEventListener('click', (e) => {
    if (!frozen) return;

    // Check if click is inside badge
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    if (
        clickX >= badgePos.x &&
        clickX <= badgePos.x + badgePos.width &&
        clickY >= badgePos.y &&
        clickY <= badgePos.y + badgePos.height
    ) {
        const uberLink = 'uber://?action=setPickup&pickup=my_location&dropoff[latitude]=37.7749&dropoff[longitude]=-122.4194';
        window.location.href = uberLink;
    }
});
</script>
</body>
</html>
